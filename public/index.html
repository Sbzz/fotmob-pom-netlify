<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FotMob 2025–26 Stats Pipeline</title>
  <style>
    :root{--bg:#0b0f14;--panel:#131a22;--muted:#223040;--text:#e7eef7;--sub:#a7b3c2;--accent:#69e0ff;--ok:#20c997;--warn:#ffc107;--err:#ff6b6b}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b0f14,#0d141c 30%,#0b0f14);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
    .wrap{max-width:1200px;margin:0 auto;padding:24px}
    .title{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .badge{padding:3px 8px;border:1px solid var(--muted);border-radius:999px;color:var(--sub);font-size:12px}

    /* Top grid */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;align-items:start}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}

    .card{background:var(--panel);border:1px solid var(--muted);border-radius:16px;padding:16px}

    /* Two consistent columns inside each section */
    .form-grid{display:grid;grid-template-columns:minmax(360px,1fr) minmax(360px,1fr);gap:16px;align-items:start}
    @media (max-width:980px){.form-grid{grid-template-columns:1fr}}
    .stack{display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:10px;flex-wrap:wrap}

    textarea{width:100%;min-height:180px;background:#0e141c;color:var(--text);border:1px solid var(--muted);border-radius:12px;padding:10px;resize:vertical}
    input[type=file],input[type=number]{border:1px solid var(--muted);border-radius:10px;padding:10px;background:#0e141c;color:var(--sub);width:100%}

    button{background:#172231;border:1px solid #263446;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
    .primary{background:linear-gradient(180deg,#1b6aa5,#124a75);border-color:#0e3c5f}
    .btn{width:100%}
    button:disabled{opacity:.6;cursor:not-allowed}

    .kpis{display:flex;gap:12px;flex-wrap:wrap}
    .kpi{background:#0f1722;border:1px solid var(--muted);padding:10px 14px;border-radius:12px;min-width:140px}
    .kpi .num{font-weight:700;font-size:20px}

    .logs{max-height:280px;overflow:auto;border:1px solid var(--muted);border-radius:12px;background:#0c121a;padding:10px}
    .log-line{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;color:var(--sub)}
    .log-line.ok{color:var(--ok)} .log-line.warn{color:var(--warn)} .log-line.err{color:var(--err)}

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{text-align:left;padding:8px 10px}
    thead th{color:var(--sub);font-weight:600;border-bottom:1px solid var(--muted)}
    tbody tr{background:#0f1722;border:1px solid var(--muted)}
    tbody td:first-child{border-top-left-radius:8px;border-bottom-left-radius:8px}
    tbody td:last-child{border-top-right-radius:8px;border-bottom-right-radius:8px}

    .downloads{display:flex;gap:8px;flex-wrap:wrap}
    .hint{color:var(--sub);font-size:13px}
    .pill{display:inline-block;padding:2px 8px;border:1px solid var(--muted);border-radius:999px;color:var(--sub);font-size:12px}
    details>summary{cursor:pointer;color:var(--sub);margin-bottom:8px}
    .footer{opacity:.8;color:var(--sub);margin-top:24px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">
      <h1 style="margin:0">FotMob 2025–26 Stats Pipeline</h1>
      <span class="badge">Season: 2025‑07‑01 → 2026‑06‑30</span>
      <span class="badge">Leagues: PL(47) · LaLiga(87) · Bundesliga(54) · Serie A(55) · Ligue 1(53)</span>
    </div>

    <div class="grid" style="margin-top:18px">
      <!-- 1) Provide players -->
      <div class="card">
        <h3 style="margin-top:0">1) Provide players</h3>
        <div class="form-grid">
          <div class="stack">
            <label class="hint">Paste <b>player URLs</b> (one per line) or <b>CSV</b> (<code class="inline">name,url</code> or just <code class="inline">url</code>)</label>
            <textarea id="paste" placeholder="https://www.fotmob.com/players/1467236/lamine-yamal\nhttps://www.fotmob.com/players/846033/vinicius-junior"></textarea>
          </div>
          <div class="stack">
            <label class="hint">Load from file / site</label>
            <input type="file" id="file" accept=".csv,text/csv,text/plain" />
            <div class="row">
              <button id="load-players" class="btn" title="Fetch /players.csv">Load /players.csv</button>
            </div>
            <div class="row">
              <button id="load-urls" class="btn" title="Fetch /url.csv">Load /url.csv</button>
            </div>
            <div class="row">
              <button id="clear" class="btn">Clear</button>
              <button id="reset" class="btn">Reset</button>
            </div>
            <div class="hint">URLs are normalized (strip locale/query/hash) → <code class="inline">/players/&lt;id&gt;/&lt;slug&gt;</code>. Duplicates dropped.</div>
          </div>
        </div>
      </div>

      <!-- 2) Run -->
      <div class="card">
        <h3 style="margin-top:0">2) Run</h3>
        <div class="form-grid">
          <div class="stack">
            <label class="hint">Batching / throttling</label>
            <div class="row">
              <div style="flex:1 1 160px">
                <small class="hint">DISCOVER_BATCH_SIZE</small>
                <input id="batch-size" type="number" min="1" max="10" value="1" />
              </div>
              <div style="flex:1 1 160px">
                <small class="hint">CHECK_CONCURRENCY</small>
                <input id="check-concurrency" type="number" min="1" max="5" value="2" />
              </div>
            </div>
          </div>
          <div class="stack">
            <label class="hint">Actions</label>
            <div class="row">
              <button id="run" class="primary btn">Run Pipeline</button>
            </div>
            <div class="row">
              <button id="stop" class="btn">Stop</button>
            </div>
            <div class="row">
              <button id="reset2" class="btn">Reset</button>
            </div>
          </div>
        </div>
        <div class="kpis" style="margin-top:10px">
          <div class="kpi"><div class="label">Players</div><div class="num" id="kpi-players">0</div></div>
          <div class="kpi"><div class="label">Matches found</div><div class="num" id="kpi-found">0</div></div>
          <div class="kpi"><div class="label">Matches checked</div><div class="num" id="kpi-checked">0</div></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3 style="margin-top:0">Logs</h3>
      <div id="logs" class="logs" aria-live="polite"></div>
    </div>

    <div class="card" style="margin-top:16px">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
        <h3 style="margin:0">Results</h3>
        <div class="downloads">
          <button id="dl-totals-csv" disabled>totals.csv</button>
          <button id="dl-totals-json" disabled>totals.json</button>
          <button id="dl-rows-csv" disabled>rows.csv</button>
          <button id="dl-rows-json" disabled>rows.json</button>
        </div>
      </div>
      <div class="hint" style="margin:6px 0 12px">Exports include POTM, FMP, goals (NPG/PG), assists, YCs, RCs. Rows = per‑match. Totals = per‑player aggregates.</div>

      <details open>
        <summary>Totals per player</summary>
        <div style="overflow:auto">
          <table id="totals-table">
            <thead>
              <tr>
                <th>Player</th>
                <th>URL</th>
                <th>Matches</th>
                <th>POTM</th>
                <th>FMP</th>
                <th>Goals</th>
                <th>NPG</th>
                <th>PG</th>
                <th>Assists</th>
                <th>YC</th>
                <th>RC</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </details>

      <details open style="margin-top:12px">
        <summary>Per‑match rows</summary>
        <div style="overflow:auto">
          <table id="rows-table">
            <thead>
              <tr>
                <th>Player</th>
                <th>Match</th>
                <th>League</th>
                <th>Kickoff (UTC)</th>
                <th>Rating</th>
                <th>POTM</th>
                <th>FMP</th>
                <th>Goals</th>
                <th>NPG</th>
                <th>PG</th>
                <th>Assists</th>
                <th>YC</th>
                <th>RC</th>
                <th>URL</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </details>
    </div>

    <div class="footer">Backend: <code>/.netlify/functions/discover</code> and <code>/.netlify/functions/check</code>. Frontend handles retries, throttling, de‑dup, and exports. Rows now include only <em>appearances</em> (DNP filtered).</div>
  </div>

<script>
(()=>{
  const $=s=>document.querySelector(s); const sleep=ms=>new Promise(r=>setTimeout(r,ms)); const jitter=(a=120,b=320)=>Math.floor(Math.random()*(b-a+1))+a;
  const allowedLeagueIds=new Set([47,87,54,55,53]); const SEASON_START=new Date('2025-07-01T00:00:00Z'); const SEASON_END=new Date('2026-06-30T23:59:59Z');
  const logEl=$('#logs'); function log(m,l='info'){const d=document.createElement('div'); d.className=`log-line ${l==='ok'?'ok':l==='warn'?'warn':l==='err'?'err':''}`; d.textContent=`[${new Date().toISOString().replace('T',' ').replace('Z','')}] ${m}`; logEl.appendChild(d); logEl.scrollTop=logEl.scrollHeight;}
  function clearLogs(){logEl.innerHTML='';}

  function stripBOM(s){return (s&&s.charCodeAt(0)===0xFEFF)?s.slice(1):s}
  function looksLikeUrl(s){try{const u=new URL(s.trim());return /fotmob\.com/.test(u.hostname)}catch{return false}}
  function parseCsv(text){text=stripBOM(text||'').replace(/\r\n/g,'\n').trim(); if(!text) return []; const lines=text.split(/\n+/).map(s=>s.trim()).filter(Boolean);
    const allUrl=lines.every(ln=>looksLikeUrl(ln)||/,\s*https?:\/\//.test(ln)); if(allUrl && !/,/.test(lines[0])) return lines.map(u=>({name:'',url:u}));
    const rows=[]; let i=0,cur='',inQ=false,rec=[]; const pushCell=()=>{rec.push(cur);cur=''}; const pushRow=()=>{rows.push(rec);rec=[]}; while(i<text.length){const ch=text[i++]; if(inQ){ if(ch==='"'){ if(text[i]==='"'){cur+='"';i++} else inQ=false } else cur+=ch } else { if(ch==='"') inQ=true; else if(ch===',') pushCell(); else if(ch==='\n'){ pushCell(); pushRow(); } else cur+=ch } } pushCell(); if(rec.length) pushRow(); while(rows.length && rows[rows.length-1].every(c=>!c.trim())) rows.pop(); let start=0; if(rows.length){ const hdr=rows[0].map(c=>c.toLowerCase().trim()); if(hdr.includes('url')||hdr.join(',')==='name,url') start=1; } const out=[]; for(let r=start;r<rows.length;r++){ const cols=rows[r]; if(!cols.length) continue; let name='',url=''; if(cols.length===1){ if(looksLikeUrl(cols[0])) url=cols[0].trim(); else name=cols[0].trim(); } else { name=(cols[0]||'').trim(); url=(cols[1]||'').trim(); if(!url && looksLikeUrl(name)){ url=name; name=''; } } if(!url) continue; out.push({name,url}); } return out; }
  function normalizePlayerUrl(raw){try{const u=new URL(raw.trim()); if(!/fotmob\.com$/.test(u.hostname)) return null; let p=u.pathname.replace(/^\/(?:[a-z]{2}-[A-Z]{2}|[a-z]{2})\//,'/'); const m=p.match(/\/players\/(\d+)\/([^\/?#]+)/); if(!m) return null; return `https://www.fotmob.com/players/${m[1]}/${decodeURIComponent(m[2]).toLowerCase()}`;}catch{return null}}
  function esc(s){return String(s==null?'':s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}
  function csvEscape(v){if(v==null) return ''; const s=String(v); return /[",\n]/.test(s)? '"'+s.replace(/"/g,'""')+'"':s}
  function toCSV(rows){ if(!rows.length) return ''; const cols=Object.keys(rows[0]); const out=[cols.join(',')]; for(const r of rows) out.push(cols.map(c=>csvEscape(r[c])).join(',')); return out.join('\n'); }
  function download(name,content,mime='text/plain;charset=utf-8'){ const blob=new Blob([content],{type:mime}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),800) }

  let abort=false; const state={inputs:[],discover:new Map(),perPlayer:new Map(),rows:[],totals:[]};
  function reset(){abort=false; state.inputs=[]; state.discover.clear(); state.perPlayer.clear(); state.rows=[]; state.totals=[]; $('#kpi-players').textContent='0'; $('#kpi-found').textContent='0'; $('#kpi-checked').textContent='0'; $('#totals-table tbody').innerHTML=''; $('#rows-table tbody').innerHTML=''; setDownloads(false);}
  function setDownloads(on){ $('#dl-totals-csv').disabled=!on; $('#dl-totals-json').disabled=!on; $('#dl-rows-csv').disabled=!on; $('#dl-rows-json').disabled=!on; }

  async function postJSON(url,body){ const r=await fetch(url,{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify(body)}); const t=await r.text(); let j=null; try{ j=t?JSON.parse(t):null;}catch{} if(!r.ok) throw new Error(`${url} ${r.status}: ${t.slice(0,180)}`); return j; }
  const asPlayers = (data)=> Array.isArray(data)? data : (data&&Array.isArray(data.players)? data.players : []);

  async function discoverBatch(urls){ try{ return await postJSON('/.netlify/functions/discover',{urls}); }catch(e){ log(`discover batch error: ${e.message}`,'warn'); return null; } }
  async function checkOne(matchUrl, playerId, playerName){ try{ return await postJSON('/.netlify/functions/check',{matchUrl,playerId,playerName}); }catch(e){ log(`check error ${matchUrl}: ${e.message}`,'warn'); return null; } }

  function didPlay(res){ const s=res&&res.player_stats||{}; const mins=Number(s.minutes_played||0); const any = (Number(s.goals||0)+Number(s.assists||0)+Number(s.yellow_cards||0)+Number(s.red_cards||0)+Number(s.penalty_goals||0))>0; const ratingOk = res&&res.player_rating!=null && !Number.isNaN(Number(res.player_rating)); return mins>0 || any || ratingOk; }

  async function run(){ reset(); clearLogs();
    const pasted=parseCsv($('#paste').value); const fileRows=await getFileRows(); const combined=[...pasted,...fileRows]; if(!combined.length){ log('No input provided. Paste URLs or load CSV.','err'); return; }
    for(const row of combined){ const norm=normalizePlayerUrl(row.url); if(!norm){ log(`Skipping invalid URL: ${row.url}`,'warn'); continue; } const pid=Number((norm.match(/players\/(\d+)/)||[])[1]||0)||null; state.inputs.push({name:row.name||'',url:row.url,normUrl:norm,playerId:pid}); }
    const uniq=new Map(); for(const r of state.inputs){ if(!uniq.has(r.normUrl)) uniq.set(r.normUrl,r); } state.inputs=[...uniq.values()]; if(!state.inputs.length){ log('No valid FotMob player URLs after normalization.','err'); return; }
    $('#kpi-players').textContent=String(state.inputs.length);

    const BATCH=Math.max(1,Math.min(10,Number($('#batch-size').value||1))); const urlList=state.inputs.map(r=>r.normUrl); const batches=[]; for(let i=0;i<urlList.length;i+=BATCH) batches.push(urlList.slice(i,i+BATCH));
    for(let i=0;i<batches.length;i++){ if(abort) return; const chunk=batches[i]; log(`Discover batch ${i+1}/${batches.length} (${chunk.length} urls)…`); let data=await discoverBatch(chunk); if(!data){ await sleep(400+jitter()); data=await discoverBatch(chunk);} const arr=asPlayers(data)||[]; for(const p of arr){ if(p&&p.player_url){ const norm=normalizePlayerUrl(p.player_url)||p.player_url; state.discover.set(norm,p); } } const got=new Set(arr.map(p=>normalizePlayerUrl(p.player_url))); const missing=chunk.filter(u=>!got.has(normalizePlayerUrl(u))); if(missing.length){ log(`Re‑queueing ${missing.length} missing…`,'warn'); batches.splice(i+1,0,missing);} }

    for(const inp of state.inputs){ if(abort) return; let d=state.discover.get(inp.normUrl); if(!d){ for(const v of state.discover.values()){ if(v.player_id && Number(v.player_id)===inp.playerId){ d=v; break; } } } if(!d || !Array.isArray(d.match_urls)){ log(`Retrying discover for ${inp.normUrl}`,'warn'); const d2=await discoverBatch([inp.normUrl]); const arr=asPlayers(d2); if(arr[0]) d=arr[0]; }
      if(!d){ log(`No discover result for ${inp.normUrl}`,'warn'); continue; }
      const playerId=Number(d.player_id||inp.playerId); const playerName=d.player_name||inp.name||(inp.normUrl.split('/').pop().replace(/-/g,' ')); const playerUrl=d.player_url||inp.normUrl; const seen=new Set(); const matches=(d.match_urls||[]).filter(u=>{ const m=(u||'').match(/match\/(\d+)/); const id=m?m[1]:null; if(!id||seen.has(id)) return false; seen.add(id); return true; }); state.perPlayer.set(playerId,{playerId,playerName,playerUrl,matches,results:[],seenKeys:new Set()}); }

    const totalFound=[...state.perPlayer.values()].reduce((a,p)=>a+p.matches.length,0); $('#kpi-found').textContent=String(totalFound); log(`Discovered ${totalFound} match URLs across ${state.perPlayer.size} players.`,'ok');

    const CONC=Math.max(1,Math.min(5,Number($('#check-concurrency').value||2))); log(`Running checks with concurrency=${CONC}…`);
    const tasks=[]; for(const p of state.perPlayer.values()) for(const mu of p.matches) tasks.push({p,mu}); let kept=0; $('#kpi-checked').textContent='0';
    function keyFrom(r){ return r.fixture_key || `${r.league_id||'X'}|${(r.match_datetime_utc||'').slice(0,16)}|${r.home_team_id||r.home_team_name}|${r.away_team_id||r.away_team_name}`; }
    async function worker(){ while(tasks.length && !abort){ const job=tasks.shift(); if(!job) break; const {p,mu}=job; await sleep(jitter()); const r=await checkOne(mu,p.playerId,p.playerName); if(r&&r.league_id!=null){ const lid=Number(r.league_id); const dt=r.match_datetime_utc?new Date(r.match_datetime_utc):null; if(allowedLeagueIds.has(lid)&&dt&&dt>=SEASON_START&&dt<=SEASON_END){ if(didPlay(r)){ const k=keyFrom(r); if(!p.seenKeys.has(k)){ p.seenKeys.add(k); const s=r.player_stats||{}; const goals=Number(s.goals||0), pg=Number(s.penalty_goals||0), npg=Math.max(0,goals-pg); const row={player:p.playerName,match:r.match_title||'',league:r.league_label||String(lid),kickoff_utc:r.match_datetime_utc||'',rating:r.player_rating??'',potm:r.player_is_pom?1:0,fmp:s.full_match_played?1:0,goals,npg,pg,assists:Number(s.assists||0),yc:Number(s.yellow_cards||0),rc:Number(s.red_cards||0),match_url:mu}; appendRows([row]); kept++; $('#kpi-checked').textContent=String(kept); } } } } } }
    await Promise.all(Array.from({length:CONC},worker)); if(abort){ log('Aborted.','warn'); return; }

    state.rows=[]; state.totals=[]; for(const p of state.perPlayer.values()){ const rows=p.results; state.rows.push(...rows); const t=rows.reduce((a,r)=>{a.matches++; a.potm+=+r.potm||0; a.fmp+=+r.fmp||0; a.goals+=+r.goals||0; a.npg+=+r.npg||0; a.pg+=+r.pg||0; a.assists+=+r.assists||0; a.yc+=+r.yc||0; a.rc+=+r.rc||0; return a;},{player:p.playerName,url:p.playerUrl,matches:0,potm:0,fmp:0,goals:0,npg:0,pg:0,assists:0,yc:0,rc:0}); state.totals.push(t); }
    renderTotals(state.totals); if($('#rows-table tbody').children.length===0 && state.rows.length) appendRows(state.rows); setDownloads(true); log('Done. Exports are ready.','ok');
  }

  function renderTotals(rows){ const tb=$('#totals-table tbody'); tb.innerHTML=''; for(const r of rows){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${esc(r.player)}</td><td><a href="${esc(r.url)}" target="_blank">link</a></td><td>${r.matches}</td><td>${r.potm}</td><td>${r.fmp}</td><td>${r.goals}</td><td>${r.npg}</td><td>${r.pg}</td><td>${r.assists}</td><td>${r.yc}</td><td>${r.rc}</td>`; tb.appendChild(tr);} }
  function appendRows(rows){ const tb=$('#rows-table tbody'); const frag=document.createDocumentFragment(); for(const r of rows){ const tr=document.createElement('tr'); tr.innerHTML=`<td>${esc(r.player)}</td><td>${esc(r.match)}</td><td>${esc(r.league)}</td><td><span class="pill">${esc(r.kickoff_utc)}</span></td><td>${r.rating==null?'':esc(r.rating)}</td><td>${r.potm}</td><td>${r.fmp}</td><td>${r.goals}</td><td>${r.npg}</td><td>${r.pg}</td><td>${r.assists}</td><td>${r.yc}</td><td>${r.rc}</td><td><a href="${esc(r.match_url)}" target="_blank">match</a></td>`; frag.appendChild(tr);} tb.appendChild(frag); const pId=[...state.perPlayer.keys()][0]; }

  function setButtons(dis){ $('#run').disabled=dis; $('#stop').disabled=!dis; $('#reset').disabled=dis; $('#reset2').disabled=dis; $('#load-players').disabled=dis; $('#load-urls').disabled=dis; $('#clear').disabled=dis; $('#file').disabled=dis; $('#batch-size').disabled=dis; $('#check-concurrency').disabled=dis; }

  async function getFileRows(){ const f=$('#file').files&&$('#file').files[0]; if(!f) return []; const t=await f.text(); return parseCsv(t); }

  $('#load-players').addEventListener('click', async()=>{ try{ const r=await fetch('/players.csv'); if(!r.ok) throw new Error(`HTTP ${r.status}`); $('#paste').value=(await r.text()).trim(); log('Loaded /players.csv','ok'); }catch(e){ log(`Failed to load /players.csv: ${e.message}`,'err'); } });
  $('#load-urls').addEventListener('click', async()=>{ try{ const r=await fetch('/url.csv'); if(!r.ok) throw new Error(`HTTP ${r.status}`); $('#paste').value=(await r.text()).trim(); log('Loaded /url.csv','ok'); }catch(e){ log(`Failed to load /url.csv: ${e.message}`,'err'); } });
  $('#clear').addEventListener('click',()=>{ $('#paste').value=''; $('#file').value=''; log('Cleared input.'); });
  $('#reset, #reset2').forEach?$('#reset, #reset2'):null; // for environments without NodeList.forEach
  document.querySelectorAll('#reset,#reset2').forEach(btn=>btn.addEventListener('click',()=>{ reset(); clearLogs(); $('#paste').value=''; $('#file').value=''; log('Reset complete.','ok'); }));
  $('#run').addEventListener('click', async()=>{ if($('#run').disabled) return; abort=false; setButtons(true); clearLogs(); log('Starting pipeline…'); try{ await run(); } finally{ setButtons(false); } });
  $('#stop').addEventListener('click',()=>{ abort=true; log('Stop requested…','warn'); });

  $('#dl-totals-csv').onclick=()=>download('totals.csv',toCSV(state.totals),'text/csv;charset=utf-8');
  $('#dl-totals-json').onclick=()=>download('totals.json',JSON.stringify(state.totals,null,2),'application/json');
  $('#dl-rows-csv').onclick=()=>download('rows.csv',toCSV(state.rows),'text/csv;charset=utf-8');
  $('#dl-rows-json').onclick=()=>download('rows.json',JSON.stringify(state.rows,null,2),'application/json');
})();
</script>
</body>
</html>
