<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>FotMob POM (Top-5 leagues, 2025–26)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; max-width: 960px; margin: 2rem auto; padding: 0 1rem; }
    textarea, input, button { width: 100%; padding: .6rem; margin: .3rem 0; }
    pre { background: #f6f8fa; padding: 1rem; overflow: auto; border-radius: 8px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: .75rem; }
    @media (max-width: 640px){ .row { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <h1>FotMob Player-of-the-Match (Top-5 domestic leagues, 2025–26)</h1>

  <label>Player URLs (one per line)</label>
  <textarea id="urls" rows="8" placeholder="https://www.fotmob.com/players/1467236/lamine-yamal
https://www.fotmob.com/players/1021382/joao-pedro"></textarea>

  <div class="row">
    <div>
      <label>Max matches per player</label>
      <input id="maxMatches" type="number" value="20" />
    </div>
    <div>
      <label>Concurrency (checks at once)</label>
      <input id="concurrency" type="number" value="3" />
    </div>
  </div>

  <button id="run">Run</button>
  <button id="downloadCsv" disabled>Download CSV</button>

  <h3>Status</h3>
  <pre id="status">—</pre>
  <h3>Output</h3>
  <pre id="out">—</pre>

  <script>
    const out = document.getElementById("out");
    const statusEl = document.getElementById("status");
    const btn = document.getElementById("run");
    const dl = document.getElementById("downloadCsv");
    let lastCsv = "";

    function csvFromBundles(bundles){
      const headers = ["player_name","player_url","match_url","match_title","league_label","match_datetime_utc","rating"];
      const lines = [headers.join(",")];
      for (const b of bundles) {
        const pname = (b.player_name || "").replace(/,/g, " ");
        const purl = b.player_url || "";
        for (const r of b.pom_2025_26_domestic || []) {
          lines.push([pname, purl, r.match_url || "", (r.match_title || "").replace(/,/g, " "),
            (r.league_label || "").replace(/,/g, " "), r.match_datetime_utc || "", r.rating == null ? "" : String(r.rating)].join(","));
        }
      }
      return lines.join("\n");
    }

    async function runChecksForPlayer(player) {
      const { player_url, player_name, match_urls } = player;
      const limit = Number(document.getElementById("concurrency").value || 3);
      const queue = [...match_urls];
      const results = [];
      let inFlight = 0;
      let done = 0;

      return new Promise((resolve) => {
        const pump = async () => {
          if (queue.length === 0 && inFlight === 0) return resolve(results);
          while (inFlight < limit && queue.length) {
            const matchUrl = queue.shift();
            inFlight++;
            fetch("/.netlify/functions/check", {
              method: "POST",
              headers: { "content-type": "application/json" },
              body: JSON.stringify({ playerName: player_name, matchUrl })
            })
            .then(r => r.json())
            .then(d => { results.push(d); })
            .catch(e => { results.push({ match_url: matchUrl, error: String(e) }); })
            .finally(() => {
              inFlight--; done++;
              statusEl.textContent = `Checking ${player_name}: ${done}/${match_urls.length} matches…`;
              pump();
            });
          }
        };
        pump();
      });
    }

    btn.onclick = async () => {
      dl.disabled = true;
      out.textContent = "—";
      statusEl.textContent = "Discovering match URLs…";

      const urls = document.getElementById("urls").value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
      const maxMatches = Number(document.getElementById("maxMatches").value || 20);

      // 1) Discover
      let playersResp;
      try {
        const r = await fetch("/.netlify/functions/discover", {
          method: "POST",
          headers: { "content-type": "application/json", "accept": "application/json" },
          body: JSON.stringify({ urls, maxMatches })
        });
      
        const raw = await r.text();        // read text first
        let data = null;
        try { data = raw ? JSON.parse(raw) : null; } catch { /* not JSON */ }
      
        if (!r.ok) {
          statusEl.textContent = `Discover error: HTTP ${r.status} ${r.statusText}\n` +
            (data ? JSON.stringify(data, null, 2) : (raw || "(empty response)"));
          return;
        }
        if (!data) {
          statusEl.textContent = "Discover returned an empty response (possibly a timeout). Try fewer players / smaller maxMatches.";
          return;
        }
        playersResp = data;
      } catch (e) {
        statusEl.textContent = "Discover failed (network/parse): " + e;
        return;
      }

      // 2) Check (fan-out)
      const bundles = [];
      for (const p of players) {
        const checked = await runChecksForPlayer(p);
        const filtered = checked.filter(r => r.league_allowed && r.within_season_2025_26 && r.player_is_pom);
        bundles.push({
          player_url: p.player_url,
          player_name: p.player_name,
          checked_matches: checked.length,
          pom_2025_26_domestic_count: filtered.length,
          pom_2025_26_domestic: filtered,
          raw: checked
        });
      }

      // 3) Summarise + CSV
      const totals = bundles.map(b => ({ player_name: b.player_name, total: b.pom_2025_26_domestic_count }));
      const summary = {
        players_processed: bundles.length,
        total_pom_hits_2025_26_domestic: bundles.reduce((a,b)=>a+(b.pom_2025_26_domestic_count||0),0)
      };

      lastCsv = csvFromBundles(bundles);
      dl.disabled = !lastCsv;

      out.textContent = JSON.stringify({ results: bundles, totals, summary }, null, 2);
      statusEl.textContent = "Done.";
    };

    dl.onclick = () => {
      if (!lastCsv) return;
      const blob = new Blob([lastCsv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "pom_results_2025_26.csv";
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    };
  </script>
</body>
</html>
