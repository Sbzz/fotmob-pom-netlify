<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>POTM & Match Stats — Top 5 Leagues (2025–26)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0b0d10; --card:#12161b; --muted:#151b23; --text:#e9eef5; --sub:#9fb3c8;
      --accent:#6ee7b7; --accent2:#60a5fa; --warn:#f59e0b; --error:#f87171; --ok:#34d399;
      --chip:#1f2937; --border:#223041; --shadow:0 10px 30px rgba(0,0,0,.35); --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0a0c10,#0b0d10 40%,#0b0d10);color:var(--text);
         font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    a{color:var(--accent2);text-decoration:none;word-break:break-word}
    .wrap{max-width:1200px;margin:32px auto;padding:0 18px}
    header{display:flex;align-items:center;gap:14px;margin-bottom:18px;flex-wrap:wrap}
    header .logo{width:38px;height:38px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));box-shadow:var(--shadow)}
    header h1{font-size:22px;margin:0}
    .tag{margin-left:auto;background:rgba(110,231,183,.12);color:var(--accent);padding:6px 10px;border-radius:999px;border:1px solid rgba(110,231,183,.35);font-size:12px}

    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow)}
    .controls{padding:16px}
    .form-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:16px}
    @media (max-width: 960px){ .form-grid{grid-template-columns:1fr} }

    .block{background:var(--muted);border:1px solid var(--border);border-radius:12px;padding:12px;min-height:100%}
    label{display:block;font-size:12px;color:var(--sub);margin-bottom:8px}
    textarea{width:100%;background:#0f141a;color:var(--text);border:1px solid #223041;border-radius:10px;padding:10px 12px;resize:vertical;min-height:110px;line-height:1.45}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:10px}
    button{appearance:none;border:0;background:linear-gradient(135deg,var(--accent2),#38bdf8);color:#0b1220;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:var(--shadow)}
    button.secondary{background:#1f2a37;color:#e5eef7;border:1px solid #29415b;box-shadow:none}
    button.ghost{background:transparent;border:1px dashed #2a3c52;color:#c8d6e5}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .status{padding:14px 16px;border-top:1px solid var(--border);display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{background:var(--chip);border:1px solid var(--border);color:#d3e0ef;padding:6px 10px;border-radius:999px;font-size:12px}
    .pill.ok{background:rgba(52,211,153,.12);color:var(--ok);border-color:rgba(52,211,153,.35)}
    .pill.warn{background:rgba(245,158,11,.12);color:var(--warn);border-color:rgba(245,158,11,.35)}
    .pill.error{background:rgba(248,113,113,.12);color:var(--error);border-color:rgba(248,113,113,.35)}

    .progress{flex:1 1 200px;min-width:220px;display:flex;align-items:center;gap:8px}
    .bar{position:relative;flex:1;height:10px;background:#0f141a;border-radius:999px;border:1px solid #223041;overflow:hidden}
    .bar>span{position:absolute;left:0;top:0;height:100%;width:0%;background:linear-gradient(90deg,var(--accent2),#38bdf8);transition:width .2s ease}
    .progress small{color:#9fb3c8;font-size:12px;min-width:120px}

    .results{margin-top:22px;display:grid;grid-template-columns:1fr;gap:16px}
    .playerCard{padding:16px;border-radius:16px;background:linear-gradient(180deg,var(--card),#0f1318);border:1px solid var(--border)}
    .head{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap}
    .head .name{font-weight:800;font-size:18px}
    .summaryLine{background:rgba(96,165,250,.11);border:1px solid rgba(96,165,250,.35);color:#dbeafe;padding:10px 12px;border-radius:12px;font-size:14px;line-height:1.5;box-shadow:var(--shadow)}
    .grid{overflow:auto;border:1px solid var(--border);border-radius:12px;margin-top:12px}

    /* --- Column alignment/widths (PATCH) --- */
    table{ width:100%; border-collapse:collapse; font-size:13px; table-layout:fixed; }
    th,td{ padding:10px 12px; border-bottom:1px solid #1f2a33; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    th{position:sticky;top:0;background:#10151b;color:#9fb3c8;font-weight:700}
    tr:hover td{background:#0f141a}
    th.center, td.center { text-align:center; }
    th.num, td.num { text-align:center; font-variant-numeric: tabular-nums; }
    .col-match{ width:48%; }
    .col-league{ width:16%; }
    .col-num{ width:auto; }

    .footerActions{margin-top:20px;display:flex;gap:10px;flex-wrap:wrap}
    .small{font-size:12px}.muted{color:#9fb3c8}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"></div>
      <h1>POTM & Match Stats (Top-5 Leagues • 2025–26)</h1>
      <span class="tag">Netlify Functions</span>
    </header>

    <div class="card">
      <div class="controls">
        <div class="form-grid">
          <div class="block">
            <label>Player profile URLs (one per line)</label>
            <textarea id="urls" placeholder="https://www.fotmob.com/players/1467236/lamine-yamal&#10;https://www.fotmob.com/players/1021382/joao-pedro"></textarea>
            <div class="row">
              <button id="btnDiscover">1) Discover Matches</button>
              <button class="secondary" id="btnReset">Reset</button>
              <button class="ghost" id="btnLoadPlayersCsv">Load /players.csv</button>
              <button class="ghost" id="btnLoadUrlCsv">Load /url.csv</button>
            </div>
            <div class="row small muted">Season: 2025–26 • Leagues: PL, LaLiga, Bundesliga, Serie A, Ligue 1</div>
          </div>

          <div class="block">
            <label>Discovered match URLs (auto) — you can paste match links here</label>
            <textarea id="matches"></textarea>
            <div class="row">
              <button id="btnRun">2) Run Checks</button>
              <button class="ghost" id="btnDownloadSummary" disabled>Download Summary CSV</button>
              <button class="ghost" id="btnDownloadDetails" disabled>Download Details CSV</button>
              <button class="ghost" id="btnDownloadPotmOnly" disabled>Download POTM Table</button>
              <button class="ghost" id="btnDiscoverDebug" disabled>Download Discover Debug</button>
            </div>
          </div>
        </div>
      </div>
      <div class="status" id="status">
        <span class="pill">Idle</span>
        <div class="progress" id="discoverProg" style="display:none">
          <div class="bar"><span></span></div>
          <small id="discoverLbl">Discovering…</small>
        </div>
        <div class="progress" id="checkProg" style="display:none">
          <div class="bar"><span></span></div>
          <small id="checkLbl">Checking…</small>
        </div>
      </div>
    </div>

    <div class="results" id="results"></div>

    <div class="footerActions">
      <button class="ghost" id="btnDownloadJSON" disabled>Download JSON</button>
      <span class="small muted">Summary = per-player totals. Details = per-match rows (played only). POTM Table = “player | POTM count”.</span>
    </div>
  </div>

  <script>
    // ---------- Config ----------
    const DISCOVER_BATCH_SIZE = 1;          // <-- leave as-is (your stable setup)
    const DISCOVER_RETRIES = 1;
    const DISCOVER_PAUSE_MS = 250;

    // ---------- DOM helpers ----------
    const qs=(s,el=document)=>el.querySelector(s);
    const urlsEl=qs('#urls'), matchesEl=qs('#matches'), resultsEl=qs('#results'), statusEl=qs('#status');
    const btnDiscover=qs('#btnDiscover'), btnReset=qs('#btnReset'), btnRun=qs('#btnRun');
    const btnDownloadSummary=qs('#btnDownloadSummary'), btnDownloadDetails=qs('#btnDownloadDetails'), btnDownloadJSON=qs('#btnDownloadJSON');
    const btnDownloadPotmOnly=qs('#btnDownloadPotmOnly'), btnDiscoverDebug=qs('#btnDiscoverDebug');
    const btnLoadPlayersCsv=qs('#btnLoadPlayersCsv'), btnLoadUrlCsv=qs('#btnLoadUrlCsv');

    const discoverProg=qs('#discoverProg'), discoverBar=discoverProg.querySelector('.bar>span'), discoverLbl=qs('#discoverLbl');
    const checkProg=qs('#checkProg'), checkBar=checkProg.querySelector('.bar>span'), checkLbl=qs('#checkLbl');

    function setStatusPills(pills){ statusEl.querySelectorAll('.pill').forEach(n=>n.remove()); for(const p of pills){ const e=document.createElement('span'); e.className='pill '+(p.type||''); e.textContent=p.text; statusEl.prepend(e);} }
    function appendStatus(text,type=''){ const e=document.createElement('span'); e.className='pill '+type; e.textContent=text; statusEl.prepend(e); }

    function showDiscoverProgress(show){ discoverProg.style.display=show?'flex':'none'; if(!show){ discoverBar.style.width='0%'; discoverLbl.textContent=''; } }
    function setDiscoverProgress(done,total){ const pct = total? Math.round((done/total)*100):0; discoverBar.style.width=pct+'%'; discoverLbl.textContent = `Discovering ${done}/${total}`; }
    function showCheckProgress(show){ checkProg.style.display=show?'flex':'none'; if(!show){ checkBar.style.width='0%'; checkLbl.textContent=''; } }
    function setCheckProgress(done,total){ const pct = total? Math.round((done/total)*100):0; checkBar.style.width=pct+'%'; checkLbl.textContent = `Checking ${done}/${total}`; }

    // ---------- Robust fetch helper ----------
    async function fetchJSONSafe(url, opts={}){
      const res  = await fetch(url, opts);
      const text = await res.text();
      let data = null;
      try{ data = text ? JSON.parse(text) : null; }
      catch(e){ throw new Error(`Bad JSON from ${url} (status ${res.status}). Body: ${text?.slice(0,200)||'<empty>'}`); }
      if(!res.ok){
        const msg=(data&&(data.error||data.message))||text||`HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    }

    // ---------- Utils ----------
    const throttleQueue=(items,limit,worker)=>new Promise(resolve=>{
      let i=0, active=0, out=[];
      const next=()=>{ if(i>=items.length && active===0) return resolve(out);
        while(active<limit && i<items.length){
          const idx=i++, item=items[idx]; active++;
          Promise.resolve(worker(item,idx))
            .then(res=>{ out[idx]=res; })
            .catch(err=>{ out[idx]={error:String(err)}; })
            .finally(()=>{ active--; next(); });
        }
      };
      next();
    });
    function chunk(arr, size){ const out=[]; for(let i=0;i<arr.length;i+=size) out.push(arr.slice(i,i+size)); return out; }
    function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

    function downloadCSV(filename, rows){
      const csv=[rows[0].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')]
        .concat(rows.slice(1).map(r=>r.map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(',')))
        .join('\r\n');
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}), url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }
    function downloadJSON(filename,obj){
      const blob=new Blob([JSON.stringify(obj,null,2)],{type:'application/json'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=filename;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    const slugToName=(url)=>{ try{ const parts=new URL(url||'').pathname.split('/'); const slug=decodeURIComponent(parts[parts.length-1]||'').replace(/-/g,' ').trim(); return slug?slug.replace(/\b\w/g,c=>c.toUpperCase()):''; }catch{ return ''; } };
    const resolveName=(player)=>{ const a=(player?.player_name||'').trim(); if(a) return a; for(const r of (player?.raw||[])){ if(r && r.echo_player_name){ const n=String(r.echo_player_name).trim(); if(n) return n; } } return slugToName(player?.player_url||'') || '(unknown)'; };
    const pidFromUrl=(u)=>{ const m=(u||'').match(/\/players\/(\d+)(?:\/|$)/); return m?Number(m[1]):null; };

    function normalizePlayerUrl(u){
      try{
        const url=new URL(u.trim());
        url.hash=''; url.search=''; url.protocol='https:'; url.hostname='www.fotmob.com';
        const m=url.pathname.match(/\/players\/(\d+)(?:\/|$)/); if(!m) return u.trim();
        const id=m[1]; const slug=(url.pathname.split('/').pop()||'').toLowerCase();
        url.pathname=`/players/${id}/${slug}`; return url.toString().replace(/\/?$/,'');
      }catch{ return u.trim(); }
    }

    function didAppear(r){
      const s=r?.player_stats||{};
      if(s.full_match_played) return true;
      if(Number(s.minutes_played||0)>0) return true;
      const counted=(Number(s.goals||0)+Number(s.penalty_goals||0)+Number(s.assists||0)+Number(s.yellow_cards||0)+Number(s.red_cards||0));
      if(counted>0) return true;
      if(r?.player_rating!=null && !Number.isNaN(Number(r.player_rating))) return true;
      return false;
    }

    function aggregate(rows){
      const ok=(rows||[]).filter(r=>r && !r.error).filter(didAppear);
      const acc={played:0,potm:0,goals:0,npg:0,pg:0,assists:0,yc:0,rc:0,fmp:0};
      for(const r of ok){
        const s=r.player_stats||{};
        acc.played+=1;
        if(r.player_is_pom) acc.potm+=1;
        const g=Number(s.goals||0), pg=Number(s.penalty_goals||0);
        acc.goals += g; acc.pg += pg; acc.npg += Math.max(0, g-pg);
        acc.assists += Number(s.assists||0);
        acc.yc += Number(s.yellow_cards||0);
        acc.rc += Number(s.red_cards||0);
        acc.fmp += (s.full_match_played?1:0);
      }
      for(const k of Object.keys(acc)) acc[k]=Math.trunc(acc[k]);
      return acc;
    }

    function renderPlayerCard(p){
      const nm=resolveName(p);
      const card=document.createElement('div'); card.className='playerCard';
      const head=document.createElement('div'); head.className='head';
      head.innerHTML=`<div class="name">${nm}</div><div class="muted small" style="max-width:100%;overflow:hidden;text-overflow:ellipsis">${p.player_url||''}</div>`;
      card.appendChild(head);

      const agg=aggregate(p.raw);
      const summary=document.createElement('div'); summary.className='summaryLine';
      summary.textContent=`• ${nm}: played ${agg.played}, POTM ${agg.potm} | Goals ${agg.goals} (NPG ${agg.npg}, PG ${agg.pg}) | Ast ${agg.assists} | YC ${agg.yc} | RC ${agg.rc} | FMP ${agg.fmp}`;
      card.appendChild(summary);

      const grid=document.createElement('div'); grid.className='grid';
      const table=document.createElement('table');
      table.innerHTML = `
        <colgroup>
          <col class="col-match"/>
          <col class="col-league"/>
          <col class="col-num"/><col class="col-num"/><col class="col-num"/><col class="col-num"/>
          <col class="col-num"/><col class="col-num"/><col class="col-num"/><col class="col-num"/><col class="col-num"/>
        </colgroup>
        <thead>
          <tr>
            <th>Match</th>
            <th>League</th>
            <th class="center">POTM?</th>
            <th class="num">Rating</th>
            <th class="num">G</th>
            <th class="num">NPG</th>
            <th class="num">PG</th>
            <th class="num">A</th>
            <th class="num">YC</th>
            <th class="num">RC</th>
            <th class="num">FMP</th>
          </tr>
        </thead>
        <tbody></tbody>`;

      const tb=table.querySelector('tbody');
      for(const r of (p.raw||[])){
        if(!didAppear(r)) continue; // show only appearances
        const s=r.player_stats||{};
        const tr=document.createElement('tr'); tr.innerHTML=`
          <td><a href="${r.match_url}" target="_blank" rel="noopener">${r.match_title||r.resolved_match_id||'match'}</a></td>
          <td>${r.league_label??''}</td>
          <td class="center">${r.player_is_pom?'✅':''}</td>
          <td class="num">${(r.player_rating!=null?Number(r.player_rating).toFixed(2):'')}</td>
          <td class="num">${s.goals??''}</td>
          <td class="num">${Math.max(0, Number(s.goals||0)-Number(s.penalty_goals||0))}</td>
          <td class="num">${s.penalty_goals??''}</td>
          <td class="num">${s.assists??''}</td>
          <td class="num">${s.yellow_cards??''}</td>
          <td class="num">${s.red_cards??''}</td>
          <td class="num">${s.full_match_played?'90+':''}</td>`;
        tb.appendChild(tr);
      }
      grid.appendChild(table); card.appendChild(grid);
      return card;
    }

    // ---------- State for downloads ----------
    let lastSummary=[], lastDetails=[], lastPotmOnly=[], lastJSON=null, lastDiscoverDebug=null;

    const toSummaryCSV=(res)=>{
      const rows=[["player_name","player_url","played","potm","goals","npg","pg","assists","yc","rc","fmp"]];
      for(const p of res){ const a=aggregate(p.raw);
        rows.push([resolveName(p),p.player_url,a.played,a.potm,a.goals,a.npg,a.pg,a.assists,a.yc,a.rc,a.fmp]);
      }
      return rows;
    };
    const toPotmOnlyCSV=(res)=>{
      const rows=[["player_name","player_url","potm"]];
      for(const p of res){ const a=aggregate(p.raw); rows.push([resolveName(p),p.player_url,a.potm]); }
      return rows;
    };
    const toDetailsCSV=(res)=>{
      const rows=[["player_name","player_url","match_url","match_title","league","potm","rating","goals","npg","pg","assists","yc","rc","fmp"]];
      for(const p of res){ for(const r of (p.raw||[])){ if(!didAppear(r)) continue; const s=r.player_stats||{};
        rows.push([resolveName(p),p.player_url,r.match_url,r.match_title||r.resolved_match_id||'',r.league_label??'',r.player_is_pom?"1":"0",(r.player_rating!=null?String(Number(r.player_rating).toFixed(2)):""),s.goals??'',Math.max(0, Number(s.goals||0)-Number(s.penalty_goals||0)),s.penalty_goals??'',s.assists??'',s.yellow_cards??'',s.red_cards??'',s.full_match_played?"1":"0"]);
      }} return rows;
    };

    // ---------- CSV loaders ----------
    async function loadCsvAt(path){
      try{
        const res=await fetch(path,{cache:'no-store'});
        const txt=await res.text();
        return txt.replace(/^\uFEFF/, '');
      }catch(e){ appendStatus(`Load failed: ${path}`,'error'); return ''; }
    }
    function parsePlayersCsv(text){
      const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const out=[];
      if(!lines.length) return out;
      const looksHeader = /(^|,)\s*(name|player)\s*(,|$)/i.test(lines[0]) && /(^|,)\s*url\s*(,|$)/i.test(lines[0]);
      const start = looksHeader?1:0;
      for(let i=start;i<lines.length;i++){
        const row = lines[i];
        const cells = []; let cur=''; let q=false;
        for(const ch of row){ if(ch=='"'){ q=!q; continue; } if(ch===',' && !q){ cells.push(cur); cur=''; } else cur+=ch; }
        cells.push(cur);
        const url = (cells[1]??cells[0]??'').trim();
        if(/\/players\//.test(url)) out.push(normalizePlayerUrl(url));
      }
      return Array.from(new Set(out));
    }

    btnLoadPlayersCsv.addEventListener('click', async()=>{
      const txt = await loadCsvAt('/players.csv');
      if(!txt) return;
      const urls = parsePlayersCsv(txt);
      if(!urls.length){ appendStatus('No player URLs found in players.csv','warn'); return; }
      urlsEl.value = urls.join('\n');
      appendStatus(`Loaded ${urls.length} from players.csv`,'ok');
    });

    btnLoadUrlCsv.addEventListener('click', async()=>{
      const txt = await loadCsvAt('/url.csv');
      if(!txt) return;
      const lines=txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const list=[];
      if(!lines.length){ appendStatus('url.csv empty','warn'); return; }
      const headerHasUrl = /(^|,)\s*url\s*(,|$)/i.test(lines[0]);
      const start = headerHasUrl?1:0;
      for(let i=start;i<lines.length;i++){
        const row=lines[i];
        if(headerHasUrl){
          const cells=[]; let cur=''; let q=false; for(const ch of row){ if(ch=='"'){ q=!q; continue;} if(ch===',' && !q){ cells.push(cur); cur=''; } else cur+=ch; } cells.push(cur);
          const url=(cells[0]||'').trim(); if(/\/players\//.test(url)) list.push(normalizePlayerUrl(url));
        }else{
          const url=row; if(/\/players\//.test(url)) list.push(normalizePlayerUrl(url));
        }
      }
      const uniq=Array.from(new Set(list));
      if(!uniq.length){ appendStatus('No player URLs found in url.csv','warn'); return; }
      urlsEl.value = uniq.join('\n');
      appendStatus(`Loaded ${uniq.length} from url.csv`,'ok');
    });

    // ---------- Reset ----------
    function hardReset(){
      urlsEl.value=''; matchesEl.value=''; resultsEl.innerHTML='';
      lastSummary=[]; lastDetails=[]; lastPotmOnly=[]; lastJSON=null; lastDiscoverDebug=null;
      btnDownloadSummary.disabled=btnDownloadDetails.disabled=btnDownloadJSON.disabled=btnDownloadPotmOnly.disabled=btnDiscoverDebug.disabled=true;
      setStatusPills([{text:'Reset',type:'ok'}]);
      delete window.__players;
      showDiscoverProgress(false); showCheckProgress(false);
    }
    btnReset.addEventListener('click', hardReset);

    // ---------- Discover (BATCHED) ----------
    async function runDiscoverBatch(urls){
      const data = await fetchJSONSafe('/.netlify/functions/discover',{
        method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({ urls })
      });
      const players = Array.isArray(data?.players) ? data.players : (Array.isArray(data)? data : []);
      return { players, raw:data };
    }

    btnDiscover.addEventListener('click', async()=>{
      resultsEl.innerHTML='';
      const lines=urlsEl.value.split(/\r?\n/).map(s=>normalizePlayerUrl(s)).filter(Boolean);
      if(!lines.length){ setStatusPills([{text:'Paste at least one FotMob player URL',type:'error'}]); return; }

      setStatusPills([{text:`Running discover for ${lines.length} players…`,type:'warn'}]);
      showDiscoverProgress(true); setDiscoverProgress(0, lines.length);

      const batches = chunk(lines, DISCOVER_BATCH_SIZE);
      const allPlayers=[]; const allMatchUrls=[]; const debugPack=[];
      let done=0;

      for(let i=0;i<batches.length;i++){
        const batch=batches[i];
        let attempt=0, res=null;
        do{
          attempt++;
          appendStatus(`[${new Date().toLocaleTimeString()}] Discover batch ${i+1}/${batches.length} (${batch.length} urls)…`, 'warn');
          try{ res = await runDiscoverBatch(batch); }catch(e){ res=null; }
          if(!res || !res.players || res.players.length===0){
            appendStatus(`Batch ${i+1} returned empty${attempt<=DISCOVER_RETRIES? ' — retrying…':''}`,'error');
            if(attempt<=DISCOVER_RETRIES) await sleep(400);
          }
        } while((!res || !res.players || res.players.length===0) && attempt<=DISCOVER_RETRIES);

        const players = (res && res.players) ? res.players : [];
        for(const p of players){
          allPlayers.push(p);
          for(const u of (p.match_urls||[])) allMatchUrls.push(u);
          debugPack.push({ player_url:p.player_url, player_id:p.player_id, team_id:p.team_id, team_slug:p.team_slug, matches_found:(p.match_urls||[]).length, debug:p.debug });
        }
        done += batch.length; setDiscoverProgress(done, lines.length);
        await sleep(DISCOVER_PAUSE_MS);
      }

      matchesEl.value = Array.from(new Set(allMatchUrls)).join('\n');
      window.__players = allPlayers.map(p=>({
        player_url:p.player_url,
        player_name:(p.player_name||'').trim() || (p.player_url.split('/').pop()||'').replace(/-/g,' '),
        player_id:p.player_id || (p.player_url && (p.player_url.match(/\/players\/(\d+)/)||[])[1]) || null,
        match_urls:(p.match_urls||[])
      }));

      lastDiscoverDebug = debugPack; btnDiscoverDebug.disabled = !(lastDiscoverDebug && lastDiscoverDebug.length);

      setStatusPills([{text:`Players: ${allPlayers.length}`,type:'ok'},{text:`Matches found: ${allMatchUrls.length}`,type:allMatchUrls.length?'ok':'warn'}]);
      showDiscoverProgress(false);
    });

    // ---------- Run checks ----------
    btnRun.addEventListener('click', async()=>{
      resultsEl.innerHTML=''; setStatusPills([{text:'Checking matches…',type:'warn'}]);
      btnDownloadSummary.disabled=btnDownloadDetails.disabled=btnDownloadJSON.disabled=btnDownloadPotmOnly.disabled=true;

      const discovered=(window.__players&&window.__players.length)?window.__players:[];
      const pasted=matchesEl.value.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const players=discovered.length?discovered:[{player_url:'',player_name:'',player_id:null,match_urls:pasted}];
      const results=[];

      showCheckProgress(true); setCheckProgress(0, players.length);

      for(let pi=0; pi<players.length; pi++){
        const p = players[pi];
        const matchUrls=(p.match_urls&&p.match_urls.length)?p.match_urls:pasted.filter(u=>/\/match\/\d+/.test(u));
        const pid=p.player_id?Number(p.player_id):null;
        const tasks=matchUrls.map(u=>({ matchUrl:u, playerId:pid, playerName:p.player_name||'' }));

        const perMatch=await throttleQueue(tasks,3,async(t)=>{
          try{
            const j=await fetchJSONSafe('/.netlify/functions/check',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({playerId:t.playerId||undefined,playerName:t.playerName||undefined,matchUrl:t.matchUrl})});
            if(j && j.league_allowed && j.within_season_2025_26) return j; // keep only eligible
            return null;
          }catch(_e){ return null; }
        });

        const seen = new Map();
        for (const r of (perMatch||[]).filter(Boolean)) {
          const key = r.fixture_key || `${r.league_id||'X'}|${(r.match_datetime_utc||'').slice(0,16)}|${r.home_team_id||r.home_team_name}|${r.away_team_id||r.away_team_name}`;
          if (!seen.has(key)) { seen.set(key, r); continue; }
          const prev = seen.get(key);
          const better = (r.player_is_pom && !prev.player_is_pom) ? r
                       : ((Number(r.player_rating||0) > Number(prev.player_rating||0)) ? r : prev);
          seen.set(key, better);
        }
        const ok2 = Array.from(seen.values());

        if((!p.player_name||p.player_name==='(unknown)') && ok2.length && ok2[0].echo_player_name){ p.player_name=ok2[0].echo_player_name; }

        results.push({ player_url:p.player_url, player_name:p.player_name, raw: ok2 });
        appendStatus(`✓ ${resolveName({player_name:p.player_name,player_url:p.player_url})}: ${ok2.filter(didAppear).length} played`,'ok');
        setCheckProgress(pi+1, players.length);
      }

      resultsEl.innerHTML='';
      for(const r of results) resultsEl.appendChild(renderPlayerCard(r));

      lastSummary = toSummaryCSV(results);
      lastDetails = toDetailsCSV(results);
      lastPotmOnly = toPotmOnlyCSV(results);
      lastJSON = { results };

      btnDownloadSummary.disabled = btnDownloadDetails.disabled = btnDownloadJSON.disabled = btnDownloadPotmOnly.disabled = false;

      setStatusPills([{text:`Players processed: ${results.length}`,type:'ok'},{text:`Matches (played): ${results.reduce((a,p)=>a+p.raw.filter(didAppear).length,0)}`,type:'ok'}]);
      showCheckProgress(false);
    });

    // ---------- Downloads ----------
    btnDownloadSummary.addEventListener('click',()=>{ if(lastSummary.length) downloadCSV('summary_potm_stats_2025_26.csv', lastSummary); });
    btnDownloadDetails.addEventListener('click',()=>{ if(lastDetails.length) downloadCSV('details_potm_stats_2025_26.csv', lastDetails); });
    btnDownloadPotmOnly.addEventListener('click',()=>{ if(lastPotmOnly.length) downloadCSV('potm_table_2025_26.csv', lastPotmOnly); });
    btnDownloadJSON.addEventListener('click',()=>{ if(lastJSON) downloadJSON('potm_stats_2025_26.json', lastJSON); });
    btnDiscoverDebug.addEventListener('click',()=>{ if(lastDiscoverDebug) downloadJSON('discover_debug.json', lastDiscoverDebug); });

    // Prefill a couple of sample players
    urlsEl.value=['https://www.fotmob.com/players/1467236/lamine-yamal','https://www.fotmob.com/players/1021382/joao-pedro'].join('\n');
  </script>
</body>
</html>
