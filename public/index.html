<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FotMob POTM & Stats • 2025–26 (Top 5 Leagues)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0b0f14; --card:#121922; --muted:#8aa0b7; --text:#e9f0f7;
      --accent:#4cc9f0; --good:#06d6a0; --warn:#ffd166; --bad:#ef476f; --border:#1f2b3a;
    }
    html, body { background: var(--bg); color: var(--text); margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica Neue, Arial;
    }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 960px){ .grid { grid-template-columns: 1.1fr 1fr; } }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,0.25); }
    .title { font-size: 20px; margin: 0 0 10px; font-weight: 700; letter-spacing: .2px; }
    .muted { color: var(--muted); font-size: 13px;}
    textarea, input, button, .btn { font: inherit; }
    textarea, input[type="text"] { width: 100%; background: #0f1620; border: 1px solid var(--border); color: var(--text); padding: 10px 12px; border-radius: 12px; outline: none; }
    textarea { min-height: 110px; resize: vertical; }
    .row { display:flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .btn { background: #162231; border: 1px solid var(--border); color: var(--text); padding: 10px 12px; border-radius: 12px; cursor: pointer; }
    .btn:hover { border-color: #2b3a51; }
    .btn.accent { background: var(--accent); color: #061019; border: none; }
    .btn.good { background: var(--good); color: #041411; border: none; }
    .btn.warn { background: var(--warn); color: #1e1200; border: none; }
    .pill { display:inline-block; padding: 4px 8px; border-radius: 999px; background: #0f1620; border:1px solid var(--border); font-size: 12px; color: var(--muted); }
    .hr { height:1px; background: var(--border); margin: 12px 0; }
    .table-wrap { overflow:auto; border-radius: 12px; border:1px solid var(--border); }
    table { width:100%; border-collapse: collapse; min-width: 760px; }
    th, td { padding: 10px 12px; border-bottom: 1px solid var(--border); text-align: left; }
    th { background: #0f1620; position: sticky; top: 0; z-index: 1; }
    tr:hover td { background: #0e1520; }
    .hint { font-size: 12px; color: var(--muted); margin-top: 4px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1 style="margin:0 0 8px">Top 5 Leagues • 2025–26 • POTM & Match Stats</h1>
    <div class="muted">Domestic league matches only (PL, LaLiga, Bundesliga, Serie A, Ligue 1). Season: <b>2025-07-01 → 2026-06-30</b>.</div>

    <div class="grid" style="margin-top:16px">
      <div class="card">
        <div class="title">1) Choose Players</div>

        <div class="row" style="margin-bottom:8px">
          <input id="csvFile" type="file" accept=".csv" />
          <button class="btn" id="btnCsvAdd">Add from CSV</button>
          <button class="btn" id="btnCsvDefault">Load /players.csv</button>
          <span class="pill" id="csvCount">No CSV loaded</span>
        </div>
        <div class="hint">CSV format: <code>player name,url</code> per line. Header is optional.</div>

        <div class="hr"></div>

        <div class="title" style="font-size:16px;margin-top:6px">Or paste FotMob player URLs (one per line)</div>
        <textarea id="urls" placeholder="e.g.
Lamine Yamal, https://www.fotmob.com/players/1467236/lamine-yamal
Vinicius Junior, https://www.fotmob.com/players/846033/vinicius-junior
https://www.fotmob.com/players/1021382/joao-pedro"></textarea>

        <div class="row" style="margin-top:8px">
          <button class="btn" id="btnQueue">Add pasted</button>
          <button class="btn" id="btnClear">Clear list</button>
          <span class="pill" id="queuedCount">Queued: 0</span>
        </div>

        <div id="queuedList" class="hint" style="margin-top:8px"></div>
      </div>

      <div class="card">
        <div class="title">2) Run</div>
        <div class="row" style="margin-bottom:8px">
          <button class="btn accent" id="btnRun">Discover → Check</button>
          <span class="pill" id="status">Idle</span>
        </div>
        <div class="row" style="gap:12px">
          <span class="pill" id="kpiPlayers">Players: 0</span>
          <span class="pill" id="kpiMatches">Matches found: 0</span>
          <span class="pill" id="kpiChecked">Checked: 0</span>
        </div>
        <div id="log" class="muted" style="white-space: pre-wrap; margin-top:8px;"></div>

        <div class="hr"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn good" id="btnDownloadCSV">Download totals.csv</button>
          <button class="btn good" id="btnDownloadJSON">Download totals.json</button>
          <button class="btn" id="btnDownloadRowsCsv">Download rows.csv</button>
          <button class="btn" id="btnDownloadRowsJson">Download rows.json</button>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <div class="title">Results</div>
      <div id="summary" class="muted" style="margin-bottom:8px">No results yet.</div>
      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Player</th>
              <th>Checked</th>
              <th>POTM</th>
              <th>Goals</th>
              <th>NPG</th>
              <th>PG</th>
              <th>Ast</th>
              <th>YC</th>
              <th>RC</th>
              <th>FMP</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
(function(){
  // ---------- state & dom ----------
  const queued = new Map(); // url -> { name, url }
  const el = id => document.getElementById(id);
  const csvFile = el('csvFile'), btnCsvAdd = el('btnCsvAdd'), btnCsvDefault = el('btnCsvDefault'), csvCount = el('csvCount');
  const urlsTA = el('urls'), btnQueue = el('btnQueue'), btnClear = el('btnClear'), queuedList = el('queuedList'), queuedCount = el('queuedCount');
  const btnRun = el('btnRun'), status = el('status'), kpiPlayers = el('kpiPlayers'), kpiMatches = el('kpiMatches'), kpiChecked = el('kpiChecked'), logBox = el('log');
  const tbody = el('tbody'), summary = el('summary');
  const btnDownloadCSV = el('btnDownloadCSV'), btnDownloadJSON = el('btnDownloadJSON'), btnDownloadRowsCsv = el('btnDownloadRowsCsv'), btnDownloadRowsJson = el('btnDownloadRowsJson');

  // ---------- utils ----------
  const escapeHtml = s => String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const csvEscape = v => { if(v==null) v=''; v=String(v); return /[",\n]/.test(v)? `"${v.replace(/"/g,'""')}"` : v; };
  const setStatus = s => status.textContent = s;
  const log = s => { logBox.textContent += s + "\n"; logBox.scrollTop = logBox.scrollHeight; };

  // URL normalization (identical for CSV & paste)
  function normalizeUrl(u){
    if(!u && u!==0) return '';
    u = String(u).replace(/^\uFEFF/, '').trim();               // strip BOM + trim
    u = u.replace(/^["']|["']$/g, '');                         // strip wrapping quotes
    const hashIdx = u.indexOf('#'); if(hashIdx >= 0) u = u.slice(0, hashIdx);
    const qIdx = u.indexOf('?');   if(qIdx   >= 0) u = u.slice(0, qIdx);
    u = u.replace(/^https?:\/\/(m\.)?fotmob\.com/i, 'https://www.fotmob.com');
    u = u.replace(/https:\/\/www\.fotmob\.com\/[a-z]{2}-[a-z]{2}\//i, 'https://www.fotmob.com/');
    u = u.replace(/\/{2,}/g, '/').replace('https:/', 'https://').replace(/\/+$/, '');
    return u;
  }
  function isPlayerUrl(u){
    return /^https:\/\/www\.fotmob\.com\/players\/\d+\/[^/\s]+$/i.test(u);
  }
  function playerIdFromUrl(u){
    const m = String(u||'').match(/\/players\/(\d+)\//);
    return m ? m[1] : null;
  }

  function parseCsv(text){
    text = String(text || '').replace(/^\uFEFF/, '');
    const lines = text.replace(/\r/g,'').split('\n').map(s=>s.trim()).filter(Boolean);
    const out = [];
    for(const line of lines){
      let parts = []; let cur=''; let inQ=false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch === '"'){ inQ = !inQ; continue; }
        if(ch === ',' && !inQ){ parts.push(cur.trim()); cur=''; continue; }
        cur += ch;
      }
      parts.push(cur.trim());
      if(parts.length === 1){
        const url = normalizeUrl(parts[0]);
        if(isPlayerUrl(url)) out.push({ name:'', url });
        continue;
      }
      const name = parts[0] ? parts[0].replace(/^['"]|['"]$/g,'').trim() : '';
      const url  = parts[1] ? normalizeUrl(parts[1].replace(/^['"]|['"]$/g,'').trim()) : '';
      if(isPlayerUrl(url)) out.push({ name, url });
    }
    return out;
  }

  function refreshQueuedUI(){
    const arr = Array.from(queued.values());
    queuedCount.textContent = `Queued: ${arr.length}`;
    queuedList.textContent = arr.map(x=>`• ${x.name ? x.name + ' — ' : ''}${x.url}`).join('\n');
  }
  function addPlayers(items){
    let added = 0, skipped = 0;
    for(const it of items){
      if(!it || !it.url) { skipped++; continue; }
      const url = normalizeUrl(it.url);
      if(!isPlayerUrl(url)) { skipped++; continue; }
      const prev = queued.get(url);
      const name = (it.name || (prev && prev.name) || '').trim();
      queued.set(url, { name, url });
      added++;
    }
    refreshQueuedUI();
    if(added || skipped) log(`CSV add: added ${added}, skipped ${skipped}`);
    return added;
  }

  // CSV: upload or /players.csv
  const btnCsvAdd = document.getElementById('btnCsvAdd');
  const csvFile = document.getElementById('csvFile');
  btnCsvAdd.addEventListener('click', async ()=>{
    if(!csvFile.files || !csvFile.files[0]){ document.getElementById('csvCount').textContent = 'No file selected'; return; }
    const text = await csvFile.files[0].text();
    const items = parseCsv(text);
    const added = addPlayers(items);
    document.getElementById('csvCount').textContent = added ? `Loaded ${added} from CSV` : 'No valid rows';
  });
  document.getElementById('btnCsvDefault').addEventListener('click', async ()=>{
    try{
      const res = await fetch('players.csv', { cache: 'no-store' });
      if(!res.ok){ document.getElementById('csvCount').textContent = 'players.csv not found'; return; }
      const txt = await res.text();
      const items = parseCsv(txt);
      const added = addPlayers(items);
      document.getElementById('csvCount').textContent = added ? `Loaded ${added} from /players.csv` : 'No valid rows in /players.csv';
    }catch(e){ document.getElementById('csvCount').textContent = 'Error loading /players.csv'; }
  });

  // Paste
  document.getElementById('btnQueue').addEventListener('click', ()=>{
    const text = document.getElementById('urls').value || '';
    const rows = parseCsv(text);
    const loneUrls = text.split('\n').map(s=>normalizeUrl(s.trim())).filter(isPlayerUrl).map(url=>({ name:'', url }));
    const items = rows.concat(loneUrls);
    const added = addPlayers(items);
    log(`Added ${added} players from paste.`);
  });
  document.getElementById('btnClear').addEventListener('click', ()=>{ queued.clear(); refreshQueuedUI(); log('Cleared queued players.'); });

  // API calls (unchanged)
  async function discover(urls){
    const res = await fetch('/.netlify/functions/discover', {
      method: 'POST', headers: { 'content-type':'application/json' }, body: JSON.stringify({ urls })
    });
    const txt = await res.text();
    try { return JSON.parse(txt); } catch { return { ok:false, error:'Bad JSON from /discover', raw: txt.slice(0,300) }; }
  }
  async function check(matchUrl, playerId, playerName){
    const res = await fetch('/.netlify/functions/check', {
      method: 'POST', headers: { 'content-type':'application/json' }, body: JSON.stringify({ matchUrl, playerId, playerName })
    });
    const txt = await res.text();
    try { return JSON.parse(txt); } catch { return { error:'Bad JSON from /check', raw: txt.slice(0,300) }; }
  }

  function npg(goals, pg){ goals = goals|0; pg = pg|0; return Math.max(0, goals - pg); }

  function aggregate(playerName, playerUrl, rows){
    const agg = { player_name: playerName||'', player_url: playerUrl, checked: 0, potm: 0, goals: 0, pg: 0, assists: 0, yc: 0, rc: 0, fmp: 0 };
    for(const r of rows){
      if(r.error) continue;
      if(!(r.league_allowed && r.within_season_2025_26)) continue;
      agg.checked += 1;
      if(r.player_is_pom) agg.potm += 1;
      const ps = r.player_stats || {};
      agg.goals   += (ps.goals|0);
      agg.pg      += (ps.penalty_goals|0);
      agg.assists += (ps.assists|0);
      agg.yc      += (ps.yellow_cards|0);
      agg.rc      += (ps.red_cards|0);
      if(ps.full_match_played) agg.fmp += 1;
    }
    agg.npg = npg(agg.goals, agg.pg);
    return agg;
  }

  function renderTable(totals){
    const tbody = document.getElementById('tbody');
    tbody.innerHTML = '';
    for(const t of totals){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${escapeHtml(t.player_name || '(name)')}</td>
        <td>${t.checked}</td>
        <td>${t.potm}</td>
        <td>${t.goals}</td>
        <td>${t.npg}</td>
        <td>${t.pg}</td>
        <td>${t.assists}</td>
        <td>${t.yc}</td>
        <td>${t.rc}</td>
        <td>${t.fmp}</td>`;
      tbody.appendChild(tr);
    }
  }

  // simple async pool
  async function poolLimit(concurrency, tasks, worker){
    const ret = []; let i = 0; const running = new Set();
    return new Promise((resolve)=>{
      const runNext = ()=>{
        if(i >= tasks.length && running.size===0){ resolve(ret); return; }
        while(running.size < concurrency && i < tasks.length){
          const idx = i++; const t = tasks[idx];
          const p = (async ()=> worker(t, idx))()
            .then(v=>{ ret[idx]=v; running.delete(p); runNext(); })
            .catch(e=>{ ret[idx]={ error:String(e) }; running.delete(p); runNext(); });
          running.add(p);
        }
      };
      runNext();
    });
  }

  // ---------- NEW: robust join logic (URL + playerId fallback) ----------
  function buildMapsFromDiscover(discPlayers){
    const byUrl = new Map();
    const byId  = new Map();
    for(const p of discPlayers || []){
      const normUrl = normalizeUrl(p.player_url || '');
      const idStr = p.player_id != null ? String(p.player_id) : playerIdFromUrl(normUrl);
      const injectedName = (queued.get(normUrl) && queued.get(normUrl).name) || p.player_name || '';
      const item = {
        url: normUrl,
        name: injectedName,
        player_id: p.player_id || (idStr ? Number(idStr) : null),
        match_urls: Array.isArray(p.match_urls) ? p.match_urls : []
      };
      byUrl.set(normUrl, item);
      if(idStr) byId.set(idStr, item);
    }
    return { byUrl, byId };
  }

  // Run flow
  document.getElementById('btnRun').addEventListener('click', async ()=>{
    setStatus('Running…'); log('Starting…');

    const players = Array.from(queued.values());
    if(players.length===0){ log('No players queued.'); setStatus('Idle'); return; }

    document.getElementById('kpiPlayers').textContent = `Players: ${players.length}`;
    const urls = players.map(p=>p.url);

    const disc = await discover(urls);
    if(!disc || disc.ok === false){
      setStatus('Discover error');
      log(`Discover error: ${disc && (disc.error || disc.raw) || 'unknown'}`);
      return;
    }

    const { byUrl, byId } = buildMapsFromDiscover(disc.players || []);
    let totalMatches = 0;
    for(const v of byUrl.values()) totalMatches += v.match_urls.length;
    document.getElementById('kpiMatches').textContent = `Matches found: ${totalMatches}`;
    log(`Matches found: ${totalMatches}`);

    let checkedCount = 0;
    const perPlayer = [];

    for(const p of players){
      const norm = normalizeUrl(p.url);
      const idStr = playerIdFromUrl(norm);
      let d = byUrl.get(norm) || (idStr ? byId.get(idStr) : null);
      if(!d){
        // still nothing: create a placeholder so name is preserved in logs/UI
        d = { match_urls: [], player_id: idStr ? Number(idStr) : null, name: p.name, url: norm };
      }
      const matches = d.match_urls || [];

      const rows = await poolLimit(5, matches, async (mUrl)=>{
        const r = await check(mUrl, d.player_id, d.name || '');
        checkedCount++;
        if(checkedCount % 3 === 0) document.getElementById('kpiChecked').textContent = `Checked: ${checkedCount}`;
        return r;
      });

      const agg = aggregate(d.name || '', p.url, rows);
      perPlayer.push({ rows, agg });
      log(`• ${agg.player_name || '(name)'}: checked ${agg.checked}, POTM ${agg.potm} | Goals ${agg.goals} (NPG ${agg.npg}, PG ${agg.pg}) | Ast ${agg.assists} | YC ${agg.yc} | RC ${agg.rc} | FMP ${agg.fmp}`);
    }

    const totals = perPlayer.map(x=>x.agg);
    renderTable(totals);
    const sumPotm = totals.reduce((a,b)=>a + (b.potm||0),0);
    const sumChecked = totals.reduce((a,b)=>a + (b.checked||0),0);
    summary.innerHTML = `Summary: ${totals.map(t=>`• ${escapeHtml(t.player_name||'(name)')}: checked ${t.checked}, POTM ${t.potm} | Goals ${t.goals} (NPG ${t.npg}, PG ${t.pg}) | Ast ${t.assists} | YC ${t.yc} | RC ${t.rc} | FMP ${t.fmp}`).join('<br>')}<br><br><span class="muted">Players: ${totals.length} | Total POTM: ${sumPotm} | Total matches checked: ${sumChecked}</span>`;

    // downloads
    const rowsFlat = [];
    for(const block of perPlayer){
      const pname = block.agg.player_name || '';
      const purl = block.agg.player_url || '';
      for(const r of block.rows){
        rowsFlat.push({
          player_name: pname,
          player_url: purl,
          match_url: r.match_url || '',
          match_title: r.match_title || '',
          league_label: r.league_label || '',
          match_datetime_utc: r.match_datetime_utc || '',
          potm: !!r.player_is_pom,
          rating: (r.player_rating!=null? r.player_rating : ''),
          goals: r.player_stats ? r.player_stats.goals : '',
          pg: r.player_stats ? r.player_stats.penalty_goals : '',
          npg: r.player_stats ? Math.max(0, (r.player_stats.goals|0) - (r.player_stats.penalty_goals|0)) : '',
          assists: r.player_stats ? r.player_stats.assists : '',
          yc: r.player_stats ? r.player_stats.yellow_cards : '',
          rc: r.player_stats ? r.player_stats.red_cards : '',
          fmp: r.player_stats ? !!r.player_stats.full_match_played : ''
        });
      }
    }

    document.getElementById('btnDownloadCSV').onclick = ()=>{
      const lines = ['player_name,player_url,checked,potm,goals,npg,pg,assists,yc,rc,fmp'];
      for(const t of totals){
        lines.push([
          csvEscape(t.player_name||''), csvEscape(t.player_url||''), t.checked, t.potm, t.goals, t.npg, t.pg, t.assists, t.yc, t.rc, t.fmp
        ].join(','));
      }
      download('totals.csv', lines.join('\n'), 'text/csv');
    };
    document.getElementById('btnDownloadJSON').onclick = ()=> download('totals.json', JSON.stringify({ totals }, null, 2), 'application/json');

    document.getElementById('btnDownloadRowsCsv').onclick = ()=>{
      const headers = Object.keys(rowsFlat[0] || {player_name:'',player_url:'',match_url:'',match_title:'',league_label:'',match_datetime_utc:'',potm:'',rating:'',goals:'',pg:'',npg:'',assists:'',yc:'',rc:'',fmp:''});
      const lines = [ headers.join(',') ];
      for(const r of rowsFlat){ lines.push(headers.map(h=>csvEscape(r[h])).join(',')); }
      download('rows.csv', lines.join('\n'), 'text/csv');
    };
    document.getElementById('btnDownloadRowsJson').onclick = ()=> download('rows.json', JSON.stringify(rowsFlat, null, 2), 'application/json');

    setStatus('Done');
  });

  function download(filename, text, mime='text/plain'){
    const blob = new Blob([text], { type: mime });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  }
})();
</script>
</body>
</html>
